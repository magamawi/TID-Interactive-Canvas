<div id="tid-html-canvas"
     data-pdfjs-base="/wp-content/uploads/pdfjs/"
     data-rest-base="/wp-json"
     data-rest-route="/tid/v1/parse-pdf"></div>

<style>
  :root{
    --tid-brand:#e64a19; --tid-green:#2e7d32; --tid-orange:#f39c12; --tid-blue:#1e3a8a;
    --tid-text:#1f2937; --tid-muted:#6b7280; --tid-bg:#fff;
    --note-compact-title:14px; --note-compact-icon:16px; --note-expanded-title:16px; --note-expanded-icon:18px;
  }

  /* Note theme variables (title/body/comment) — #6 is light blue */
  .tcolor-1{ --note-bg:#fff8b9; --note-b:#e6d76a; --note-head-top:#fff6cf; --note-head-bot:#fff0a0; --note-comment-bg:#fff9d6; }
  .tcolor-2{ --note-bg:#e8f5e9; --note-b:#a5d6a7; --note-head-top:#f1fbf2; --note-head-bot:#d8f0db; --note-comment-bg:#eefaf0; }
  .tcolor-3{ --note-bg:#fff0d6; --note-b:#ffd39b; --note-head-top:#ffe8c2; --note-head-bot:#ffd9a0; --note-comment-bg:#fff3df; }
  .tcolor-4{ --note-bg:#ffe4e6; --note-b:#fecdd3; --note-head-top:#ffecef; --note-head-bot:#ffd8dd; --note-comment-bg:#fff1f3; }
  .tcolor-5{ --note-bg:#ede9fe; --note-b:#c4b5fd; --note-head-top:#f1efff; --note-head-bot:#e3dffd; --note-comment-bg:#f3f1ff; }
  .tcolor-6{ --note-bg:#dbeafe; --note-b:#bfdbfe; --note-head-top:#eaf3ff; --note-head-bot:#d1e7ff; --note-comment-bg:#eef6ff; }

  /* Wider canvas */
  #tid-html-canvas{max-width:1800px;margin:22px auto;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--tid-text)}
  .tid-heading{font-weight:900;font-size:clamp(18px,3.4vw,26px);line-height:1.15;letter-spacing:.4px;text-transform:uppercase;color:var(--tid-brand);margin:0 0 12px}

  .tid-toolbar{margin:10px 0 14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .tid-toolbar button{
    cursor:pointer;border:1px solid #cbd5e1;background:#fff;color:var(--tid-text)!important;border-radius:10px;padding:9px 12px;font-size:14px;font-weight:700
  }
  .tid-toolbar button:hover{background:#f8fafc}
  .tid-toolbar .tid-helper{font-size:12px;color:var(--tid-muted)}

  .tid-board{position:relative;width:100%;border:6px solid var(--tid-blue);border-radius:12px;overflow:hidden;background:var(--tid-bg);box-shadow:0 10px 28px rgba(0,0,0,.06)}
  .tid-board::before{content:"";display:block;padding-top:70%}
  .is-fs .tid-board{height:100vh}
  .is-fs .tid-board::before{padding-top:0}
  .tid-grid{position:absolute;inset:0;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-template-rows:repeat(2,1fr)}

  .tid-lines{position:absolute;inset:0;pointer-events:none}
  .tid-lines line{stroke-linecap:square}
  .tid-lines .v1{stroke:var(--tid-brand);stroke-width:6px}
  .tid-lines .v2{stroke:var(--tid-green);stroke-width:6px}
  .tid-lines .h1{stroke:var(--tid-orange);stroke-width:6px}

  /* Zones: persistent scroll */
  .tid-zone{position:relative;padding:8px;overflow:auto}
  .tid-zone::-webkit-scrollbar{width:10px;height:10px}
  .tid-zone::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
  .zone-head{position:sticky;left:0;top:0;z-index:3;display:inline-flex;gap:8px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px}
  .zone-title{font-size:13px;font-weight:900;letter-spacing:.2px}
  .zone-count{font-size:12px;color:#374151;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:1px 7px;cursor:pointer}
  .zone-add{cursor:pointer;border:1px solid #cbd5e1;background:#fff;color:var(--tid-text)!important;border-radius:8px;font-size:12px;padding:4px 8px;font-weight:700}
  .zone-add:hover{background:#f3f4f6}

  .zone-questions{position:absolute;right:8px;top:8px;z-index:3;background:#fff;border:1px solid #e5e7eb;border-radius:10px;max-width:min(92%,380px)}
  .zone-questions summary{cursor:pointer;padding:6px 10px;font-size:12px;color:var(--tid-muted)}
  .zone-questions ul{margin:0;padding:0 14px 10px 22px;font-size:12px;line-height:1.35;max-height:200px;overflow:auto}

  /* Notes */
  .tid-note{position:absolute;background:var(--note-bg);border:1px solid var(--note-b);border-radius:12px;box-shadow:0 8px 22px rgba(0,0,0,.12);display:flex;flex-direction:column;overflow:hidden}
  .tid-note.compact{min-width:200px;min-height:52px;width:200px;height:60px;resize:both;overflow:hidden}
  .tid-note.expanded{min-width:240px;min-height:150px;width:370px;height:270px;resize:both;overflow:auto}

  .tid-note-header{display:flex;gap:8px;align-items:center;padding:6px 10px;background:linear-gradient(var(--note-head-top),var(--note-head-bot));border-bottom:1px solid var(--note-b);user-select:none;position:sticky;top:0;z-index:2}
  .tid-note .drag{font-weight:900;opacity:.8;cursor:grab}
  .tid-note .drag:active{cursor:grabbing}
  .tid-note.compact .drag{font-size:var(--note-compact-icon)}
  .tid-note.expanded .drag{font-size:var(--note-expanded-icon)}
  .tid-note .title{flex:1;outline:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tid-note.compact .title{font-weight:800;font-size:var(--note-compact-title)}
  .tid-note.expanded .title{font-weight:900;font-size:var(--note-expanded-title)}
  .tid-note .del{border:none;background:transparent;line-height:1;cursor:pointer;opacity:.9;color:#7c3e00;font-weight:900}
  .tid-note.compact .del{font-size:var(--note-compact-icon)}
  .tid-note.expanded .del{font-size:var(--note-expanded-icon)}
  .tid-note .del:hover{opacity:1}

  .color-dot{width:14px;height:14px;border-radius:999px;border:1px solid #a3a3a3;cursor:pointer}
  .tcolor-1 .color-dot{background:#fff8b9}
  .tcolor-2 .color-dot{background:#e8f5e9}
  .tcolor-3 .color-dot{background:#fff0d6}
  .tcolor-4 .color-dot{background:#ffe4e6}
  .tcolor-5 .color-dot{background:#ede9fe}
  .tcolor-6 .color-dot{background:#dbeafe}

  .tid-note-body{padding:10px;outline:none;font-size:14px;flex:1;display:none;background:var(--note-bg)}
  .tid-note.expanded .tid-note-body{display:block}
  .tid-note details{border-top:1px dashed var(--note-b);background:var(--note-comment-bg);display:none}
  .tid-note.expanded details{display:block}
  .tid-note summary{cursor:pointer;padding:6px 10px;font-size:12px;color:#384151}
  .tid-note textarea{width:100%;min-height:80px;border:none;outline:none;padding:8px;font-size:13px;background:#fffdf0;resize:vertical}

  /* Focus/dim */
  .focus-mode .tid-note:not(.is-active){opacity:.35; filter:saturate(.7)}

  .tid-footer{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--tid-muted);margin-top:8px}
  .tid-mini-logo{font-weight:900;color:var(--tid-blue);letter-spacing:.3px}

  /* Document Dock */
  .tid-drawer{position:fixed;top:0;right:0;width:min(520px,92vw);height:100vh;background:#fff;box-shadow:-18px 0 28px rgba(0,0,0,.2);border-left:4px solid var(--tid-blue);z-index:99999;display:none;flex-direction:column}
  .tid-drawer header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid #e5e7eb}
  .tid-drawer header h3{margin:0;font-size:16px;font-weight:900}
  .tid-drawer .body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .tid-drawer .panel{border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
  .tid-drawer .panel>header{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;padding:8px 10px;border-bottom:1px solid #e5e7eb}
  .tid-drawer .panel>header .name{font-weight:800;font-size:13px}
  .tid-drawer .panel .actions button{border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;font-weight:700;color:var(--tid-text)!important}
  .tid-drawer .panel .actions button:hover{background:#f3f4f6}
  .tid-drawer .panel .content{padding:8px}
  #tid-drawer-docs{max-height:60vh;overflow:auto}
  .tid-pdf{width:100%;height:420px;border:0;display:block}

  /* Zone index (number badge click) */
  .tid-index{position:fixed;z-index:999999;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.2);max-width:340px;max-height:300px;overflow:auto}
  .tid-index h5{margin:8px 10px;font-size:12px;color:#6b7280}
  .tid-index button{display:block;width:100%;text-align:left;padding:8px 10px;border:0;background:#fff;cursor:pointer;font-size:13px}
  .tid-index button:hover{background:#f3f4f6}

  /* PRINT: multipage with full canvas per page (no blank first page) */
  .tid-print-wrap{display:none}
  @media print{
    @page { size: A4 landscape; margin: 6mm; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .tid-heading, .tid-toolbar, .tid-footer, .tid-drawer, .tid-board, #tid-print-modal, #tid-color-modal { display:none!important; }

    .tid-print-wrap{display:block!important;margin:0}

    .tid-page{
      border:6px solid var(--tid-blue);
      border-radius:12px;
      padding:0;
      break-after:page; /* no blank first page */
      page-break-after:always;
      margin:0 0 6mm 0;
    }
    .tid-page:last-child{page-break-after:auto; break-after:auto}

    .pwrap{display:grid; grid-template-columns:repeat(3,1fr); grid-auto-rows:auto; gap:0;}
    .pzone{padding:6px; min-height:90px; display:grid; grid-auto-flow:row;
      grid-template-columns:repeat(auto-fill, minmax(130px,1fr)); gap:6px; page-break-inside:avoid}
    .pzone h4{margin:0 0 4px;font-size:11px;font-weight:900}
    .pnote{border:1px solid #e6d76a;border-radius:10px;padding:6px;page-break-inside:avoid;background:#fff8b9}
    .pnote .ptitle{font-weight:900; font-size:11px; margin-bottom:3px}
    .pnote .pbody{font-size:10px; line-height:1.25; max-height:80mm; overflow:hidden}

    .row1{border-bottom:6px solid var(--tid-orange)}
    .col1{border-right:6px solid var(--tid-brand)}
    .col2{border-right:6px solid var(--tid-green)}

    /* Fit-all-on-one-page mode */
    .fit-one .pzone{grid-template-columns:repeat(auto-fill, minmax(100px,1fr))}
    .fit-one .pnote{padding:5px}
    .fit-one .pnote .ptitle{font-size:10px}
    .fit-one .pnote .pbody{font-size:9px}

    /* Title-only mode */
    .titles-only .pnote .pbody{display:none}

    #tid-print-footer{position:fixed;bottom:3mm;right:6mm;font-size:10px;color:#374151}
    #tid-print-footer::after{content:"Page " counter(page) " of " counter(pages);}
  }

  /* Modals */
  #tid-print-modal,#tid-color-modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:999998}
  #tid-print-modal .card, #tid-color-modal .card{max-width:680px; margin:6vh auto; background:#fff; border-radius:12px; padding:14px; box-shadow:0 10px 28px rgba(0,0,0,.2)}
  #tid-print-modal h3,#tid-color-modal h3{margin:0 0 8px; font-size:18px; font-weight:900}
  #tid-print-modal fieldset{border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin:8px 0}
  #tid-print-modal legend{padding:0 6px; font-weight:800; color:#374151}
  #tid-print-modal .row{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
  #tid-print-modal .actions, #tid-color-modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
  #tid-print-modal button, #tid-color-modal button{cursor:pointer;border:1px solid #cbd5e1;background:#fff;color:var(--tid-text)!important;border-radius:10px;padding:8px 12px;font-weight:700}
  #tid-print-modal button.primary,#tid-color-modal button.primary{background:#111827;color:#fff!important;border-color:#111827}

  .color-grid{display:grid; grid-template-columns: 1fr repeat(6, 40px); gap:10px; align-items:center}
  .sw{width:34px;height:24px;border-radius:8px;border:1px solid #cbd5e1;cursor:pointer}
  .sw.c1{background:#fff8b9}.sw.c2{background:#e8f5e9}.sw.c3{background:#fff0d6}.sw.c4{background:#ffe4e6}.sw.c5{background:#ede9fe}.sw.c6{background:#dbeafe}
</style>
<style>
/* FIX: Zone jump dropdown text invisible until hover */
.tid-index { font-family: inherit; }
.tid-index h5 { color: #6b7280 !important; }

.tid-index button,
.tid-index a {
  display: block !important;
  width: 100% !important;
  text-align: left !important;
  padding: 8px 10px !important;
  border: 0 !important;
  background: #fff !important;
  color: #111827 !important;
  -webkit-text-fill-color: #111827 !important;
  font-size: 13px !important;
  font-weight: 600 !important;
  text-decoration: none !important;
  box-shadow: none !important;
}

.tid-index button:hover,
.tid-index a:hover {
  background: #f3f4f6 !important;
  color: #111827 !important;
  -webkit-text-fill-color: #111827 !important;
}
</style>


<div class="tid-heading">Enterprise Pre-Business<br>Definition Audit Canvas</div>

<div class="tid-toolbar">
  <button id="tid-toggle-drawer">Document Dock</button>
  <button id="tid-fullscreen">Fullscreen Canvas</button>
  <button id="tid-open-colors">Note Colors</button>
  <span class="tid-helper">Double-click a note to expand. Click outside to collapse. Drag by “⋮⋮”.</span>
</div>

<div class="tid-board" id="tid-board">
  <svg class="tid-lines" id="tid-lines" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
    <line class="v1" id="v1" x1="0" y1="0" x2="0" y2="0"></line>
    <line class="v2" id="v2" x1="0" y1="0" x2="0" y2="0"></line>
    <line class="h1" id="h1" x1="0" y1="0" x2="0" y2="0"></line>
  </svg>
  <div class="tid-grid">
    <section class="tid-zone" data-zone="scope" data-zone-title="Scope"></section>
    <section class="tid-zone" data-zone="customer" data-zone-title="Customer"></section>
    <section class="tid-zone" data-zone="competition" data-zone-title="Competition"></section>
    <section class="tid-zone" data-zone="offering" data-zone-title="Offering"></section>
    <section class="tid-zone" data-zone="organization" data-zone-title="Organization"></section>
    <section class="tid-zone" data-zone="rnd" data-zone-title="R&amp;D"></section>
  </div>
</div>

<!-- PRINT SHEET: multiple pages container -->
<div class="tid-print-wrap" id="tid-print-wrap" aria-hidden="true"></div>
<div id="tid-print-footer" aria-hidden="true"></div>

<div class="tid-footer">
  <div class="tid-mini-logo">TID • The Innovative Dinosaur</div>
  <div>CC BY-NC-SA 4.0 • Designed by: Motaz Agamawi</div>
</div>

<!-- Document Dock -->
<aside class="tid-drawer" id="tid-drawer">
  <header>
    <h3>Document Dock</h3>
    <div><button id="tid-close-drawer">Close</button></div>
  </header>
  <div class="body">
    <!-- Import -->
    <section class="panel" id="tid-import-panel">
      <header>
        <div class="name">Import Business Definition</div>
        <div class="actions">
          <button id="tid-open-text">Import from Text</button>
          <button id="tid-open-file">Upload PDF/JSON/CSV</button>
        </div>
      </header>
      <div class="content">
        <p class="tid-helper" style="margin:0 0 8px">Use the <strong>Dinosaur Business Definition Bot</strong> to generate a report. Paste the text or upload the file.</p>
        <input id="tid-bda-file" type="file" accept=".pdf,.json,.csv" style="display:none">
        <div id="tid-text-area-wrap" style="display:none">
          <textarea id="tid-textarea" placeholder="Paste report text here…" style="width:100%; height:160px; border:1px solid #e5e7eb; border-radius:10px; padding:10px; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:13px;"></textarea>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px">
            <button id="tid-text-import">Import</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Export & Print -->
    <section class="panel" id="tid-export-panel">
      <header>
        <div class="name">Export &amp; Print</div>
        <div class="actions">
          <button id="tid-open-print">Print</button>
          <button id="tid-export-pdf">Export PDF</button>
          <button id="tid-export-json">JSON</button>
          <button id="tid-export-csv">CSV</button>
          <button id="tid-export-txt">TXT</button>
          <button id="tid-clear">Clear All</button>
        </div>
      </header>
      <div class="content">
        <p class="tid-helper" style="margin:0">Exports use the same options as Print (Titles/Detailed &amp; Fit one page/Multi-page) and keep your note order.</p>
      </div>
    </section>

    <!-- PDFs -->
    <section class="panel">
      <header>
        <div class="name">Attached Documents</div>
        <div class="actions"><button id="tid-add-pdf">+ Add PDF</button></div>
      </header>
      <div class="content" id="tid-drawer-docs">
        <input id="tid-attach-pdfs" type="file" accept="application/pdf" multiple style="display:none">
        <p class="tid-helper" style="margin-top:0">Add PDFs to reference while you work. Click “Fullscreen” to expand.</p>
      </div>
    </section>
  </div>
</aside>

<!-- Output Options Modal -->
<div id="tid-print-modal" role="dialog" aria-modal="true" aria-labelledby="tid-print-title">
  <div class="card">
    <h3 id="tid-print-title">Output options</h3>
    <fieldset>
      <legend>Content</legend>
      <div class="row">
        <label><input type="radio" name="printContent" value="titles" checked> Titles only</label>
        <label><input type="radio" name="printContent" value="detailed"> Detailed (title + body)</label>
      </div>
    </fieldset>
    <fieldset>
      <legend>Layout</legend>
      <div class="row">
        <label><input type="radio" name="printFit" value="fit-one" checked> Fit the canvas on one page</label>
        <label><input type="radio" name="printFit" value="multi"> Expand to multiple pages</label>
      </div>
    </fieldset>
    <div class="actions">
      <button id="tid-print-cancel">Cancel</button>
      <button id="tid-print-go" class="primary">Continue</button>
    </div>
  </div>
</div>

<!-- Color Options Modal -->
<div id="tid-color-modal" role="dialog" aria-modal="true" aria-labelledby="tid-color-title">
  <div class="card">
    <h3 id="tid-color-title">Note colors per block</h3>
    <div class="color-grid">
      <div><strong>Scope</strong></div><div class="sw c1" data-zone="scope" data-color="1"></div><div class="sw c2" data-zone="scope" data-color="2"></div><div class="sw c3" data-zone="scope" data-color="3"></div><div class="sw c4" data-zone="scope" data-color="4"></div><div class="sw c5" data-zone="scope" data-color="5"></div><div class="sw c6" data-zone="scope" data-color="6"></div>
      <div><strong>Customer</strong></div><div class="sw c1" data-zone="customer" data-color="1"></div><div class="sw c2" data-zone="customer" data-color="2"></div><div class="sw c3" data-zone="customer" data-color="3"></div><div class="sw c4" data-zone="customer" data-color="4"></div><div class="sw c5" data-zone="customer" data-color="5"></div><div class="sw c6" data-zone="customer" data-color="6"></div>
      <div><strong>Competition</strong></div><div class="sw c1" data-zone="competition" data-color="1"></div><div class="sw c2" data-zone="competition" data-color="2"></div><div class="sw c3" data-zone="competition" data-color="3"></div><div class="sw c4" data-zone="competition" data-color="4"></div><div class="sw c5" data-zone="competition" data-color="5"></div><div class="sw c6" data-zone="competition" data-color="6"></div>
      <div><strong>Offering</strong></div><div class="sw c1" data-zone="offering" data-color="1"></div><div class="sw c2" data-zone="offering" data-color="2"></div><div class="sw c3" data-zone="offering" data-color="3"></div><div class="sw c4" data-zone="offering" data-color="4"></div><div class="sw c5" data-zone="offering" data-color="5"></div><div class="sw c6" data-zone="offering" data-color="6"></div>
      <div><strong>Organization</strong></div><div class="sw c1" data-zone="organization" data-color="1"></div><div class="sw c2" data-zone="organization" data-color="2"></div><div class="sw c3" data-zone="organization" data-color="3"></div><div class="sw c4" data-zone="organization" data-color="4"></div><div class="sw c5" data-zone="organization" data-color="5"></div><div class="sw c6" data-zone="organization" data-color="6"></div>
      <div><strong>R&amp;D</strong></div><div class="sw c1" data-zone="rnd" data-color="1"></div><div class="sw c2" data-zone="rnd" data-color="2"></div><div class="sw c3" data-zone="rnd" data-color="3"></div><div class="sw c4" data-zone="rnd" data-color="4"></div><div class="sw c5" data-zone="rnd" data-color="5"></div><div class="sw c6" data-zone="rnd" data-color="6"></div>
    </div>
    <p class="tid-helper">Updates all existing notes in the block and sets the default for new ones.</p>
    <div class="actions"><button id="tid-color-close" class="primary">Done</button></div>
  </div>
</div>

<script>
(function(){
  const ROOT = document.getElementById('tid-html-canvas');
  const PDFJS_BASE = (ROOT.getAttribute('data-pdfjs-base') || '').replace(/\/+$/, '');
  const REST_BASE = ROOT.getAttribute('data-rest-base') || '/wp-json';
  const REST_ROUTE = ROOT.getAttribute('data-rest-route') || '/tid/v1/parse-pdf';
  const STORAGE_KEY='tid_canvas_notes_title_only_v6';
  const ZCOLORS_KEY='tid_zone_colors_v4';

  const board=document.getElementById('tid-board');
  const svg=document.getElementById('tid-lines');
  const v1=document.getElementById('v1'), v2=document.getElementById('v2'), h1=document.getElementById('h1');
  const printWrap=document.getElementById('tid-print-wrap');
  const $=s=>document.querySelector(s);

  let lastPrintOpts={content:'titles',fit:'fit-one'};

  function layoutGrid(){
    const r = board.getBoundingClientRect();
    const w = Math.max(1, Math.round(r.width));
    const h = Math.max(1, Math.round(r.height));
    svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
    const x1 = Math.round(w/3), x2 = Math.round(2*w/3), y = Math.round(h/2);
    v1.setAttribute('x1', x1); v1.setAttribute('x2', x1); v1.setAttribute('y1', 0); v1.setAttribute('y2', h);
    v2.setAttribute('x1', x2); v2.setAttribute('x2', x2); v2.setAttribute('y1', 0); v2.setAttribute('y2', h);
    h1.setAttribute('x1', 0);  h1.setAttribute('x2', w);  h1.setAttribute('y1', y); h1.setAttribute('y2', y);
  }
  window.addEventListener('load', layoutGrid);
  new ResizeObserver(()=>{ layoutGrid(); autoPackZones(); }).observe(board);

  let zoneDefaults = loadZoneColors() || { scope:1, customer:2, competition:4, offering:3, organization:5, rnd:6 };

  const QUESTIONS={
    scope:["Industry? Field/niche?","Purpose?","Entity type?","Value chain position?"],
    customer:["Who buys vs uses?","Perception & access?","Role to customer?","Needs & demand?"],
    competition:["Competitors?","Differentiation?","Substitutes?","Core competency?"],
    offering:["What do we offer?","Portfolio & model?","Roadmap?","Revenue/margin mix?"],
    organization:["Core/support functions?","Team size & reach?","Key roles?","Cost structure?"],
    rnd:["Innovation approach?","IP & distinctiveness?","Impact KPIs?","Process maturity?","Practices/tools/budget?"]
  };

  /* Zones */
  document.querySelectorAll('.tid-zone').forEach(zone=>{
    const id=zone.dataset.zone, title=zone.dataset.zoneTitle||id;
    const head=document.createElement('div'); head.className='zone-head';
    head.innerHTML=`<div class="zone-title">${title}</div>
                    <span class="zone-count" data-count-for="${id}" title="Jump to note">0</span>
                    <button class="zone-add" data-zone="${id}">+ Note</button>`;
    zone.appendChild(head);

    head.querySelector('.zone-add').addEventListener('click', () => {
      collapseAll();
      const el = addNote(id, false);
      focusNote(el);
      autoPackZone(id, el);
      el.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
      updateZoneCounts();
    });

    // Counter dropdown (fixed position, reliable)
    head.querySelector('.zone-count').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      showZoneIndex(id, ev.clientX, ev.clientY, title);
    });

    const q=document.createElement('details'); q.className='zone-questions';
    q.innerHTML=`<summary>Guiding questions</summary><ul>${(QUESTIONS[id]||[]).map(x=>`<li>${x}</li>`).join('')}</ul>`;
    zone.appendChild(q);
  });

  /* Data */
  let notes=load(); let seq = (notes.reduce((m,n)=>Math.max(m, n.order||0), 0) || 0);
  notes.forEach(n=>createNote(n));
  updateZoneCounts(); autoPackZones();

  /* Toolbar */
  $('#tid-fullscreen').onclick=async ()=>{ try{ await board.requestFullscreen(); }catch(_){} };
  document.addEventListener('fullscreenchange', ()=>{ document.body.classList.toggle('is-fs', !!document.fullscreenElement); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && document.fullscreenElement){ try{document.exitFullscreen()}catch(_){}} });

  const drawer=$('#tid-drawer');
  $('#tid-toggle-drawer').onclick=()=>drawer.style.display = drawer.style.display==='flex' ? 'none' : 'flex';
  $('#tid-close-drawer').onclick=()=>drawer.style.display='none';

  // Colors modal
  const colorModal = $('#tid-color-modal');
  $('#tid-open-colors').onclick=()=>{ colorModal.style.display='block'; };
  $('#tid-color-close').onclick=()=>{ colorModal.style.display='none'; };
  colorModal.addEventListener('click',(e)=>{ if(e.target===colorModal) colorModal.style.display='none'; });
  colorModal.querySelectorAll('.sw').forEach(sw=>{
    sw.addEventListener('click', ()=>{
      const zone = sw.dataset.zone, c = parseInt(sw.dataset.color,10);
      zoneDefaults[zone]=c; saveZoneColors(zoneDefaults);
      board.querySelectorAll(`.tid-zone[data-zone="${zone}"] .tid-note`).forEach(el=>{
        setNoteColor(el, c);
        const m=getModel(el); if(m){ m.appliedColor=c; m.color=c; }
      });
    });
  });

  /* Import panel */
  $('#tid-open-text').onclick=()=>{
    const wrap=$('#tid-text-area-wrap');
    wrap.style.display = wrap.style.display==='none' ? 'block' : 'none';
    if(wrap.style.display==='block') $('#tid-textarea').focus();
  };
  $('#tid-text-import').onclick=()=>{
    const txt=$('#tid-textarea').value||'';
    if(!txt.trim()){ alert('Please paste the report text first.'); return; }
    importFromPlainText(txt);
    $('#tid-textarea').value='';
    alert('Imported from pasted text.');
  };
  $('#tid-open-file').onclick=()=>$('#tid-bda-file').click();
  $('#tid-bda-file').addEventListener('change', onBdaUpload);

  /* Export & Print */
  $('#tid-open-print').onclick=()=>openOutputModal();
  $('#tid-export-pdf').onclick=()=>openOutputModal(/*export*/true);
  $('#tid-export-json').onclick=()=>doExport('json');
  $('#tid-export-csv').onclick=()=>doExport('csv');
  $('#tid-export-txt').onclick=()=>doExport('txt');
  $('#tid-clear').onclick=()=>{
    if(confirm('Remove all notes stored in this browser for this page?')){
      notes=[]; save(); board.querySelectorAll('.tid-note').forEach(n=>n.remove()); updateZoneCounts();
    }
  };

  // PDFs
  $('#tid-add-pdf').onclick=()=>$('#tid-attach-pdfs').click();
  $('#tid-attach-pdfs').addEventListener('change', e=>{
    const files=[...e.target.files]; files.forEach(f=>addToDockOnly(f));
    if(files.length) drawer.style.display='flex'; e.target.value='';
  });

  /* Global click: collapse & unfocus & close index */
  document.addEventListener('click', (e)=>{
    const inside = e.target.closest('.tid-note') || e.target.closest('.tid-drawer') || e.target.closest('.zone-add') || e.target.closest('#tid-print-modal') || e.target.closest('#tid-color-modal') || e.target.closest('.tid-index');
    if(inside) return;
    collapseAll(); unfocusAll(); removeIndex();
  });

  /* Delete */
  document.addEventListener('click', (e) => {
    const btn = e.target.closest && e.target.closest('.del'); if (!btn) return;
    const el = btn.closest('.tid-note'); if (!el) return;
    e.stopPropagation();
    const id = el.dataset.id;
    if (!confirm('Delete this note?')) return;
    el.remove();
    notes = notes.filter(n => n.id !== id);
    save(); updateZoneCounts();
  }, true);

  /* Helpers */
  function uid(){ return 'n'+Date.now()+Math.random().toString(36).slice(2,7); }
  function getZoneEl(id){ return board.querySelector(`.tid-zone[data-zone="${id}"]`); }
  function getModel(el){ return notes.find(n=>n.id===el.dataset.id); }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(notes)); }
  function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[]}catch{return[]} }
  function saveZoneColors(v){ localStorage.setItem(ZCOLORS_KEY, JSON.stringify(v)); }
  function loadZoneColors(){ try{return JSON.parse(localStorage.getItem(ZCOLORS_KEY))}catch{return null} }
  function pxToPct(px, total){ return +(px/total*100).toFixed(2); }

  function setNoteColor(el, idx){
    el.classList.remove('tcolor-1','tcolor-2','tcolor-3','tcolor-4','tcolor-5','tcolor-6');
    el.classList.add('tcolor-'+idx);
  }

  function addNote(zoneId, expanded=false){
    const orderVal = ++seq;
    const colorIdx = zoneDefaults[zoneId] || 1;
    const note={id:uid(),zone:zoneId,title:'New note',body:'',comment:'',
                x:6,y:22,wPct:20,hPct:9,mode: expanded?'expanded':'compact',
                order: orderVal, userMoved:false, color:colorIdx, appliedColor:colorIdx};
    notes.push(note);
    return createNote(note);
  }

  function focusNote(el){
    board.classList.add('focus-mode');
    board.querySelectorAll('.tid-note').forEach(n=>n.classList.remove('is-active'));
    el.classList.add('is-active');
    el.style.zIndex = String(Date.now()%100000);
  }
  function unfocusAll(){ board.classList.remove('focus-mode'); board.querySelectorAll('.tid-note').forEach(n=>n.classList.remove('is-active')); }

  function createNote(model){
    const zoneEl=getZoneEl(model.zone);
    const el=document.createElement('div'); el.className='tid-note tcolor-'+(model.appliedColor||zoneDefaults[model.zone]||1); el.dataset.id=model.id;
    el.innerHTML=`
      <div class="tid-note-header">
        <span class="drag" title="Drag">⋮⋮</span>
        <div class="title" spellcheck="false"></div>
        <span class="color-dot" title="Change color"></span>
        <button class="del" title="Delete" type="button" aria-label="Delete">×</button>
      </div>
      <div class="tid-note-body" contenteditable="true" spellcheck="true"></div>
      <details><summary>Comment</summary><textarea placeholder="Add an optional comment…"></textarea></details>`;
    zoneEl.appendChild(el);

    el.classList.toggle('compact', (model.mode||'compact')==='compact');
    el.classList.toggle('expanded', (model.mode||'compact')==='expanded');

    el.querySelector('.title').textContent=model.title||'';
    el.querySelector('.tid-note-body').textContent=model.body||'';
    el.querySelector('textarea').value=model.comment||'';

    requestAnimationFrame(()=>{
      const z=zoneEl.getBoundingClientRect();
      const wPct = model.wPct ?? 20, hPct = model.hPct ?? 9;
      el.style.left   = ((model.x ?? 6)   / 100) * z.width  + 'px';
      el.style.top    = ((model.y ?? 16)  / 100) * z.height + 'px';
      el.style.width  = (wPct/100) * z.width  + 'px';
      el.style.height = (hPct/100) * z.height + 'px';
      clamp(el);
    });

    el.addEventListener('dblclick', ()=>{ (el.classList.contains('expanded')?collapse:expand)(el); });

    const titleEl = el.querySelector('.title');
    function setTitleEditable(){ if(el.classList.contains('expanded')) titleEl.setAttribute('contenteditable','plaintext-only'); else titleEl.removeAttribute('contenteditable'); }
    setTitleEditable();
    titleEl.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'||ev.key==='Tab'){ ev.preventDefault(); el.querySelector('.tid-note-body').focus(); } if(ev.key==='Escape'){ collapse(el); } });
    el.querySelector('.tid-note-body').addEventListener('input', ()=>{ getModel(el).body=el.querySelector('.tid-note-body').textContent; save(); });
    el.querySelector('textarea').addEventListener('input', ()=>{ getModel(el).comment=el.querySelector('textarea').value; save(); });
    titleEl.addEventListener('input', ()=>{ getModel(el).title=titleEl.textContent.trim(); save(); });

    el.querySelector('.color-dot').addEventListener('click', ()=>{
      const m=getModel(el); const cur = m.appliedColor || zoneDefaults[m.zone] || 1;
      const next = cur % 6 + 1; m.color=next; m.appliedColor=next; save(); setNoteColor(el, next);
    });

    // drag
    const handle=el.querySelector('.tid-note-header .drag');
    let dragging=false,startX=0,startY=0,baseL=0,baseT=0;
    handle.addEventListener('pointerdown', ev=>{
      dragging=true; ev.preventDefault(); handle.setPointerCapture(ev.pointerId);
      const r=el.getBoundingClientRect(), z=zoneEl.getBoundingClientRect();
      startX=ev.clientX; startY=ev.clientY; baseL=r.left-z.left; baseT=r.top-z.top;
      focusNote(el);
      const m=getModel(el); m.order=++seq; m.userMoved=true; save();
    });
    handle.addEventListener('pointermove', ev=>{
      if(!dragging) return;
      const z=zoneEl.getBoundingClientRect(); const r=el.getBoundingClientRect();
      let nl=baseL+(ev.clientX-startX), nt=baseT+(ev.clientY-startY);
      nl=Math.max(0,Math.min(nl,z.width-r.width)); nt=Math.max(0,Math.min(nt,z.height-r.height));
      el.style.left=nl+'px'; el.style.top=nt+'px';
    });
    handle.addEventListener('pointerup', ()=>{
      if(!dragging) return; dragging=false;
      const z=zoneEl.getBoundingClientRect(), r=el.getBoundingClientRect();
      const left=r.left-z.left, top=r.top-z.top, m=getModel(el);
      m.x=pxToPct(left,z.width); m.y=pxToPct(top,z.height); save();
    });

    // persist resize
    const ro=new ResizeObserver(()=>{
      const z=zoneEl.getBoundingClientRect(), r=el.getBoundingClientRect(), m=getModel(el);
      let w=r.width, h=r.height, l=r.left-z.left, t=r.top-z.top;
      if (w > z.width - l)  w = Math.max(200, z.width - l - 2);
      if (h > z.height - t) h = Math.max(52,  z.height - t - 2);
      el.style.width=w+'px'; el.style.height=h+'px';
      const r2=el.getBoundingClientRect();
      m.wPct=pxToPct(r2.width,z.width); m.hPct=pxToPct(r2.height,z.height); save();
    }); ro.observe(el);

    return el;
    function expand(elm){ elm.classList.remove('compact'); elm.classList.add('expanded'); const m=getModel(elm); m.mode='expanded'; save(); setTitleEditable(); setTimeout(()=>{ (elm.querySelector('.tid-note-body').textContent.trim()? elm.querySelector('.tid-note-body') : titleEl).focus(); },0); }
    function collapse(elm){ elm.classList.remove('expanded'); elm.classList.add('compact'); const m=getModel(elm); m.mode='compact'; save(); setTitleEditable(); }
  }

  function updateZoneCounts(){
    ['scope','customer','competition','offering','organization','rnd'].forEach(z=>{
      const c=notes.filter(n=>n.zone===z).length;
      const badge=document.querySelector(`.zone-count[data-count-for="${z}"]`);
      if(badge) badge.textContent=c;
    });
  }

  function collapseAll(){
    board.querySelectorAll('.tid-note.expanded').forEach(n=>{ n.classList.remove('expanded'); n.classList.add('compact'); const m=getModel(n); if(m){ m.mode='compact'; } });
    save();
  }
  function clamp(el){
    const z=el.parentElement.getBoundingClientRect(), r=el.getBoundingClientRect();
    let l=r.left-z.left, t=r.top-z.top;
    if (l < 0) l = 0;
    if (t < 0) t = 0;
    if (l + r.width > z.width)  l = Math.max(0, z.width - r.width);
    if (t + r.height > z.height) t = Math.max(0, z.height - r.height);
    el.style.left=l+'px'; el.style.top=t+'px';
  }

  /* Auto-pack compact notes; target ≥2 columns when possible */
  function autoPackZones(){ ['scope','customer','competition','offering','organization','rnd'].forEach(id=>autoPackZone(id)); }
  function autoPackZone(zoneId, onlyEl=null){
    const zoneEl = getZoneEl(zoneId); if(!zoneEl) return;
    const all = [...zoneEl.querySelectorAll('.tid-note')];
    const candidates = all.filter(el=>{
      const m=getModel(el); if(!m) return false;
      if(el.classList.contains('expanded')) return false;
      if(m.userMoved) return false;
      if(onlyEl) return el===onlyEl;
      return true;
    }).sort((a,b)=> (getModel(a).order||0) - (getModel(b).order||0));
    if(!candidates.length) return;

    const zrect = zoneEl.getBoundingClientRect();
    const headH = 56, pad = 8, gap = 8;
    const usableW = zrect.width - pad*2;
    const usableH = zrect.height - headH - pad;

    const minW = 200, cardH = 60;
    let cols = Math.floor((usableW + gap) / (minW + gap));
    if (cols < 2 && usableW >= (minW*2 + gap)) cols = 2; // try to force 2 if space permits
    cols = Math.max(1, cols);
    const width = Math.max(minW, Math.floor((usableW - (cols-1)*gap) / cols));
    const rows = Math.max(1, Math.floor((usableH + gap) / (cardH + gap)));

    const occ = Array.from({length: rows}, ()=>Array(cols).fill(false));
    all.filter(el=>!candidates.includes(el)).forEach(el=>{
      const m=getModel(el); if(!m) return;
      const col = Math.min(cols-1, Math.max(0, Math.floor((m.x/100 * zrect.width) / (width+gap))));
      const row = Math.min(rows-1, Math.max(0, Math.floor(((m.y/100 * zrect.height) - headH) / (cardH+gap))));
      if(row>=0 && col>=0) occ[row][col]=true;
    });

    function firstEmpty(){ for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ if(!occ[r][c]) return [r,c]; } } return [rows-1, cols-1]; }

    candidates.forEach(el=>{
      const [r,c] = firstEmpty(); occ[r][c]=true;
      const x = pad + c*(width+gap);
      const y = headH + pad + r*(cardH+gap);
      el.style.width = width + 'px';
      el.style.height = cardH + 'px';
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      const z = zoneEl.getBoundingClientRect();
      const m = getModel(el);
      m.x = pxToPct(x, z.width); m.y = pxToPct(y, z.height);
      m.wPct = pxToPct(width, z.width); m.hPct = pxToPct(cardH, z.height);
    });
    save();
  }

  /* Zone index dropdown */
  function showZoneIndex(zoneId, cx, cy, title){
    removeIndex();
    const menu=document.createElement('div'); menu.className='tid-index'; menu.id='tid-index';
    const items = notes.filter(n=>n.zone===zoneId).sort((a,b)=>(a.order||0)-(b.order||0));
    menu.innerHTML = `<h5>${title} — notes</h5>` + (items.length
      ? items.map(n=>`<button data-id="${n.id}" title="${escapeHtml(n.title||'Note')}">${escapeHtml(n.title||'Note')}</button>`).join('')
      : `<div style="padding:8px 10px;color:#6b7280;font-size:13px">No notes yet</div>`);
    document.body.appendChild(menu);
    const left = Math.min(window.innerWidth - menu.getBoundingClientRect().width - 12, cx + 6);
    const top  = Math.min(window.innerHeight - menu.getBoundingClientRect().height - 12, cy + 10);
    menu.style.left = Math.max(8,left)+'px';
    menu.style.top  = Math.max(8,top)+'px';
    menu.addEventListener('click', (ev)=>{
      const b = ev.target.closest('button'); if(!b) return;
      const id = b.getAttribute('data-id'); removeIndex(); jumpToNote(id);
    });
    window.addEventListener('scroll', removeIndex, {once:true});
  }
  function removeIndex(){ const m=document.getElementById('tid-index'); if(m) m.remove(); }
  function jumpToNote(id){
    const el = board.querySelector(`.tid-note[data-id="${CSS.escape(id)}"]`); if(!el) return;
    el.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
    setTimeout(()=>{ if(el.classList.contains('compact')){ el.classList.remove('compact'); el.classList.add('expanded'); const m=getModel(el); if(m){ m.mode='expanded'; save(); } } focusNote(el); const body = el.querySelector('.tid-note-body'); (body.textContent.trim()? body : el.querySelector('.title')).focus(); }, 220);
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  /* Print/Export: full-canvas on every page */
  function openOutputModal(){
    const modal=$('#tid-print-modal');
    modal.style.display='block';
    $('#tid-print-cancel').onclick=()=>modal.style.display='none';
    $('#tid-print-go').onclick=()=>{
      lastPrintOpts = {
        content: document.querySelector('input[name="printContent"]:checked').value,
        fit: document.querySelector('input[name="printFit"]:checked').value
      };
      modal.style.display='none';
      buildPrintPages(lastPrintOpts);
      setTimeout(()=>{ window.print(); }, 40);
    };
  }

  // Build multiple .tid-page so each page shows full canvas (frame + 6 zones)
  function buildPrintPages(opts){
    printWrap.innerHTML='';
    const classNames = [(opts.content==='titles'?'titles-only':''),(opts.fit==='fit-one'?'fit-one':'')].filter(Boolean).join(' ');

    // Gather notes per zone
    const ZS=['scope','customer','competition','offering','organization','rnd'];
    const byZone = Object.fromEntries(ZS.map(z=>[z, notes.filter(n=>n.zone===z).sort((a,b)=>(a.order||0)-(b.order||0))]));

    if(opts.fit==='fit-one'){
      // Single page scaled layout
      const page = makePage(classNames);
      ZS.forEach((z,idx)=> injectNotesInto(page, z, byZone[z], opts));
      printWrap.appendChild(page);
      return;
    }

    // Multipage: chunk per zone using conservative capacities
    const cap = (opts.content==='titles') ? 24 : 12; // per zone, per page
    const pagesNeeded = Math.max(...ZS.map(z=>Math.ceil(byZone[z].length / cap))) || 1;

    for(let i=0;i<pagesNeeded;i++){
      const page = makePage(classNames);
      ZS.forEach((z)=> {
        const slice = byZone[z].slice(i*cap,(i+1)*cap);
        injectNotesInto(page, z, slice, opts);
      });
      printWrap.appendChild(page);
    }
  }

  function makePage(cls){
    const page=document.createElement('section'); page.className='tid-page '+(cls||'');
    const wrap=document.createElement('div'); wrap.className='pwrap';
    wrap.innerHTML = `
      <section class="pzone row1 col1" data-zone="scope"><h4>Scope</h4></section>
      <section class="pzone row1 col2" data-zone="customer"><h4>Customer</h4></section>
      <section class="pzone row1 col3" data-zone="competition"><h4>Competition</h4></section>
      <section class="pzone row2 col1" data-zone="offering"><h4>Offering</h4></section>
      <section class="pzone row2 col2" data-zone="organization"><h4>Organization</h4></section>
      <section class="pzone row2 col3" data-zone="rnd"><h4>R&amp;D</h4></section>`;
    page.appendChild(wrap);
    return page;
  }

  function injectNotesInto(page, zoneId, arr, opts){
    const sec = page.querySelector(`.pzone[data-zone="${zoneId}"]`);
    arr.forEach(n=>{
      const card=document.createElement('div'); card.className='pnote';
      if(n.appliedColor){ card.style.borderColor = getBorderByColor(n.appliedColor); card.style.background = getBgByColor(n.appliedColor); }
      const t=document.createElement('div'); t.className='ptitle'; t.textContent=n.title||'Note';
      card.appendChild(t);
      if(opts.content==='detailed'){
        const b=document.createElement('div'); b.className='pbody'; b.textContent=n.body||''; card.appendChild(b);
      }
      sec.appendChild(card);
    });
  }

  window.addEventListener('beforeprint', ()=>buildPrintPages(lastPrintOpts));

  function getBgByColor(i){ return ({1:'#fff8b9',2:'#e8f5e9',3:'#fff0d6',4:'#ffe4e6',5:'#ede9fe',6:'#dbeafe'})[i] || '#fff8b9'; }
  function getBorderByColor(i){ return ({1:'#e6d76a',2:'#a5d6a7',3:'#ffd39b',4:'#fecdd3',5:'#c4b5fd',6:'#bfdbfe'})[i] || '#e6d76a'; }

  /* Exports */
  function doExport(kind){
    if(kind==='json'){
      const blob=new Blob([JSON.stringify(notes,null,2)],{type:'application/json'});
      download(blob,'tid-canvas-notes.json');
    } else if(kind==='csv'){
      const headers=['id','zone','title','body','comment','x','y','wPct','hPct','mode','order','color','appliedColor','userMoved'];
      const lines=[headers.join(',')].concat(notes.map(n=>headers.map(h=>csvCell(n[h])).join(',')));
      const blob=new Blob([lines.join('\n')],{type:'text/csv'});
      download(blob,'tid-canvas-notes.csv');
    } else if(kind==='txt'){
      const lines = notes.slice().sort((a,b)=>(a.order||0)-(b.order||0)).map(n=>`[${n.zone.toUpperCase()}] ${n.title}${n.body?`: ${n.body}`:''}`);
      const blob=new Blob([lines.join('\n')],{type:'text/plain'});
      download(blob,'tid-canvas-notes.txt');
    }
  }
  function csvCell(v){ const s = (v==null?'':String(v)).replace(/"/g,'""'); return `"${s}"`; }
  function download(blob, name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

  /* Importers (PDF fallback kept) */
  async function onBdaUpload(e){
    const f=e.target.files[0]; if(!f) return; const name=f.name.toLowerCase();
    try{
      if(name.endsWith('.json')){
        importCards(JSON.parse(await f.text())); alert('JSON imported.');
      } else if(name.endsWith('.csv')){
        importCards(parseCSV(await f.text())); alert('CSV imported.');
      } else if(name.endsWith('.pdf')){
        const ok = await ensurePdfJs();
        if(ok){ await importFromPDF_Client(f); alert('PDF imported via browser.'); }
        else {
          const text = await importFromPDF_Server(f);
          if(text){ importFromPlainText(text); alert('PDF imported via server.'); }
          else { addToDockOnly(f); alert('Automatic extraction not available. Paste the Bot output in the Import-from-Text box.'); }
        }
      } else { alert('Upload PDF, JSON, or CSV from the Dinosaur Business Definition Bot.'); }
    }catch(err){ console.error(err); alert('Import failed: '+err.message); }
    finally{ e.target.value=''; }
  }
  function importCards(rows){
    if(!Array.isArray(rows)) throw new Error('JSON must be an array of objects');
    const allowed=['scope','customer','competition','offering','organization','rnd'];
    rows.forEach((r,i)=>{
      const zone=(r.zone||'offering').toString().toLowerCase();
      const z=allowed.includes(zone)?zone:'offering';
      const colorIdx = zoneDefaults[z] || 1;
      const note={id:uid(),zone:z,title:(r.title||r.name||'Card'),body:(r.body||r.description||r.text||''),comment:(r.comment||r.notes||''),
                  x:(6+(i*3))%80,y:(16+(i*8))%70,wPct:20,hPct:9,mode:'compact',order:++seq,userMoved:false,color:colorIdx,appliedColor:colorIdx};
      notes.push(note); createNote(note);
    });
    save(); updateZoneCounts(); autoPackZones();
  }
  function parseCSV(text){
    const lines=text.replace(/\r/g,'').split('\n').filter(Boolean);
    if(!lines.length) return [];
    const headers=lines[0].split(',').map(h=>h.replace(/^"+|"+$/g,'').trim().toLowerCase());
    return lines.slice(1).map(row=>{
      const cells = row.match(/("([^"]|"")*"|[^,]+)/g)||[];
      const vals = cells.map(c=>c.replace(/^"+|"+$/g,'').replace(/""/g,'"'));
      const obj={}; headers.forEach((h,i)=>obj[h]=vals[i]); return obj;
    });
  }
  async function importFromPDF_Client(file){
    const buf = await file.arrayBuffer();
    const doc = await pdfjsLib.getDocument({ data: buf }).promise;
    let text=''; 
    for(let p=1;p<=doc.numPages;p++){
      const page=await doc.getPage(p);
      const tc=await page.getTextContent();
      text += tc.items.map(i=>i.str).join(' ') + '\n';
    }
    importFromPlainText(text);
  }
  async function importFromPDF_Server(file){
    const endpoint = (REST_BASE + REST_ROUTE).replace(/\/+$/, '');
    try{
      const fd = new FormData();
      fd.append('file', file, file.name);
      const res = await fetch(endpoint, { method:'POST', body: fd });
      const raw = await res.text(); let data={}; try{ data=JSON.parse(raw); }catch{}
      if(!res.ok){ throw new Error((data && (data.error||data.message)) || ('HTTP '+res.status)); }
      if(data && data.text) return data.text;
      throw new Error('Empty response from parser');
    }catch(e){ console.warn('Server fallback failed', e); return ''; }
  }
  function importFromPlainText(text){
    const sections = extractSections(text);
    const mapping = { scope: sections.scope, customer: sections.customer, competition: sections.competition, offering: sections.offering, organization: sections.organization, rnd: sections.rnd };
    let created=0;
    Object.entries(mapping).forEach(([zone,txt])=>{
      if(!txt) return;
      const bullets = extractBullets(txt);
      const colorIdx = zoneDefaults[zone] || 1;
      if(bullets.length){
        bullets.forEach((b,i)=>{
          const title = trimWords(b.split(':')[0], 12) || zone[0].toUpperCase()+zone.slice(1);
          const body  = b;
          const note={id:uid(),zone,title,body,comment:'',x:(6+(i*3))%80,y:(16+(i*8))%70,wPct:20,hPct:9,mode:'compact',order:++seq,userMoved:false,color:colorIdx,appliedColor:colorIdx};
          notes.push(note); createNote(note); created++;
        });
      } else {
        const title = zone[0].toUpperCase()+zone.slice(1);
        const note={id:uid(),zone,title,body:txt.trim(),comment:'',x:6,y:16,wPct:20,hPct:9,mode:'compact',order:++seq,userMoved:false,color:colorIdx,appliedColor:colorIdx};
        notes.push(note); createNote(note); created++;
      }
    });
    save(); updateZoneCounts(); autoPackZones();
    alert(created? `Imported ${created} notes.` : 'No importable content found. Try JSON/CSV export from the Bot.');
  }
  function extractSections(text){
    const t=' ' + text.replace(/\u2022/g,'•').replace(/\s+/g,' ').trim() + ' ';
    function grab(label, nextLabels){
      const startRe=new RegExp(`\\s(?:\\d+\\.\\s*)?${label}(?:\\sDefinition)?\\s`,'i'); const start=t.search(startRe);
      if(start<0) return ''; let end=t.length;
      for(const nl of nextLabels){
        const re=new RegExp(`\\s(?:\\d+\\.\\s*)?${nl}(?:\\sDefinition)?\\s`,'i'); const idx=t.slice(start+1).search(re);
        if(idx>=0) end=Math.min(end, start+1+idx);
      }
      return t.slice(start, end);
    }
    return {
      scope: grab('Scope',['Customer','Competition','Offering','Organization','Research']),
      customer: grab('Customer',['Competition','Offering','Organization','Research']),
      competition: grab('Competition',['Offering','Organization','Research']),
      offering: grab('Offering',['Organization','Research']),
      organization: grab('Organization',['Research']),
      rnd: grab('R\\s*&\\s*D|Research\\s*&\\s*Development|Research\\s*&\\s*Innovation',[])
    };
  }
  function extractBullets(sectionText){
    if(!sectionText) return [];
    const s=sectionText.replace(/\s+/g,' ').trim();
    let parts = s.split(/(?:•|–|-|\so\s)\s+/g).map(x=>x.trim()).filter(Boolean);
    parts = parts.filter(p=>!/^(\d+\.\s*)?(scope|customer|competition|offering|organization|research|r&d)/i.test(p));
    const out=[]; for(const p of parts){ if(out.length && p.length<30){ out[out.length-1]+='; '+p; } else out.push(p); }
    return out;
  }
  function trimWords(str, n){ const a=str.trim().split(/\s+/); return a.slice(0,n).join(' ') + (a.length>n?'…':''); }

  /* pdf.js (optional) */
  async function ensurePdfJs(){
    if(window.pdfjsLib) return true;
    const sources = [];
    if (PDFJS_BASE){
      sources.push({js:`${PDFJS_BASE}/pdf.min.js`, worker:`${PDFJS_BASE}/pdf.worker.min.js`});
      sources.push({js:`${PDFJS_BASE}/build/pdf.min.js`, worker:`${PDFJS_BASE}/build/pdf.worker.min.js`});
    }
    sources.push(
      {js:'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js', worker:'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js'},
      {js:'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js', worker:'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js'},
      {js:'https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.min.js', worker:'https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.worker.min.js'}
    );
    for(const src of sources){
      try{
        await loadScript(src.js);
        if(window.pdfjsLib){ pdfjsLib.GlobalWorkerOptions.workerSrc = src.worker; return true; }
      }catch(_e){}
    }
    return false;
  }
  function loadScript(url){ return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=url; s.onload=resolve; s.onerror=()=>reject(new Error('Failed '+url)); document.head.appendChild(s); }); }

  /* Dock PDFs */
  function addToDockOnly(file){
    const url=URL.createObjectURL(file);
    const wrap=document.createElement('div'); wrap.className='panel';
    wrap.innerHTML=`
      <header>
        <div class="name">${file.name}</div>
        <div class="actions">
          <button class="doc-fullscreen">Fullscreen</button>
          <button class="doc-remove">Remove</button>
        </div>
      </header>
      <div class="content"><embed class="tid-pdf" src="${url}" type="application/pdf"></div>`;
    const body=$('#tid-drawer-docs'); body.appendChild(wrap);
    const viewer=wrap.querySelector('.tid-pdf');
    wrap.querySelector('.doc-fullscreen').onclick=()=> {
      const el = viewer; if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    };
    wrap.querySelector('.doc-remove').onclick=()=>wrap.remove();
    const drawer=$('#tid-drawer'); drawer.style.display='flex';
  }
})();
</script>
